name: Update Badges

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed

jobs:
  update-badges:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.BADGE_BOT_APP_ID }}
          private-key: ${{ secrets.BADGE_BOT_PRIVATE_KEY }}
          
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app-token.outputs.token }}
          
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          
      - name: Generate Badges
        run: |
          ./scripts/validate.sh
          
      - name: Commit Badge Updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Badge Automation Bot"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .github/badges/
            git commit -m "chore: update badges [skip ci]"
            git push
          else
            echo "No badge changes to commit"
          fi
